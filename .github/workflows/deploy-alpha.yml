name: Deploy to Alpha

concurrency: 
    group: AlphaDeployment
    cancel-in-progress: true

on:
    push:
        tags: [ v*.*.* ]
    workflow_dispatch:

jobs:
    install:
        uses: ./.github/workflows/install.yml
        secrets:
            NODE_AUTH_TOKEN: ${{ secrets.PACKAGES_TOKEN }}
    test-unit:
        needs: [install]
        uses: ./.github/workflows/test-unit.yml
    # lint:
    #     needs: [install]
    #     uses: ./.github/workflows/lint.yml
    build:
        needs: [install]
        uses: ./.github/workflows/build.yml
        with:
            environment: alpha
            region: internal
            save: true
    confirm-deployment:
        needs: [test-unit, build]
        runs-on: ubuntu-latest
        environment:
            name: alpha-dev
            url: https://hub.alpha.kidsloop.net
        steps:
            - name: Debug message
              run: echo Echo
    deploy:
        needs: [confirm-deployment]
        uses: ./.github/workflows/deploy-aws.yml
        with:
            environment: alpha
            region: internal
            aws-region: ap-northeast-2
            aws-s3-bucket: kidsloop-alpha-live-crack-drake
            aws-cloudfront-distribution-id: E2694SIA1FLALO
        secrets:
            AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID_ALPHA_DEV }}
            AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY_ALPHA_DEV }}


